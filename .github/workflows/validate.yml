name: VCSCI Validation

on:
  push:
    branches: [ main, single-pictogram-evaluation ]
  pull_request:
    branches: [ main ]

jobs:
  validate-structure:
    name: Validate Repository Structure
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install --global ajv-cli

    - name: Check directory structure
      run: |
        echo "Checking required directories..."
        for dir in cases pictograms ratings analysis schemas scripts style docs; do
          if [ -d "$dir" ]; then
            echo "✓ $dir/ exists"
          else
            echo "✗ $dir/ missing"
            exit 1
          fi
        done

    - name: Validate phrase lists
      run: |
        echo "Validating phrase list JSON files..."
        for file in core-phrase-list-*.json; do
          if [ -f "$file" ]; then
            if jq empty "$file" 2>/dev/null; then
              echo "✓ $file is valid JSON"
            else
              echo "✗ $file is invalid JSON"
              exit 1
            fi
          fi
        done

    - name: Validate schemas
      run: |
        echo "Validating schema files..."
        cd schemas
        for schema in *.schema.json; do
          if [ -f "$schema" ]; then
            if ajv compile -s "$schema"; then
              echo "✓ $schema is valid"
            else
              echo "✗ $schema is invalid"
              exit 1
            fi
          fi
        done
        cd ..

    - name: Validate case metadata
      run: |
        echo "Validating case metadata..."
        if [ -d "cases" ] && [ "$(ls -A cases/*.json 2>/dev/null)" ]; then
          ajv validate -s schemas/case-meta.schema.json -d "cases/*.json" || true
        else
          echo "No case files to validate"
        fi

    - name: Validate rating records
      run: |
        echo "Validating rating records..."
        if [ -d "ratings" ] && [ "$(ls -A ratings/*.json 2>/dev/null)" ]; then
          ajv validate -s schemas/rating-record.schema.json -d "ratings/*.json" || true
        else
          echo "No rating files to validate"
        fi

    - name: Validate chain of thought
      run: |
        echo "Validating chain of thought integrity..."
        if [ -f "scripts/validate-chain.js" ]; then
          node scripts/validate-chain.js --all || true
        else
          echo "validate-chain.js not found, skipping"
        fi

  check-documentation:
    name: Check Documentation
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Check required documentation
      run: |
        echo "Checking required documentation files..."
        docs=(
          "README.md"
          "docs/pictogram-case.md"
          "docs/rubric.md"
          "docs/evaluation-instrument.md"
          "schemas/README.md"
        )
        for doc in "${docs[@]}"; do
          if [ -f "$doc" ]; then
            echo "✓ $doc exists"
          else
            echo "✗ $doc missing"
            exit 1
          fi
        done

    - name: Check for broken links (basic)
      run: |
        echo "Checking for obviously broken links..."
        if grep -r "](http://example.com)" docs/ README.md 2>/dev/null; then
          echo "✗ Found example.com placeholder links"
          exit 1
        else
          echo "✓ No obvious placeholder links found"
        fi

  lint-markdown:
    name: Lint Markdown Files
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Lint markdown files
      uses: DavidAnson/markdownlint-cli2-action@v11
      with:
        globs: |
          **/*.md
          !node_modules
      continue-on-error: true
